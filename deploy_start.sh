#!/bin/bash

# =================================================================================
# ğŸš€ í˜¼ë°¥í•˜ìš°ìŠ¤ ê°„í¸ ë°°í¬ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ (deploy_start.sh)
# ê¸°ëŠ¥:
#   1. ë¡œì»¬ ë³€ê²½ ì‚¬í•­ ì„ì‹œ ì €ì¥ (git stash) - ì¶©ëŒ ë°©ì§€
#   2. ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (git pull)
#   3. ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ (chmod +x)
#   4. ìë™ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (deploy.sh)
# ì‚¬ìš©ë²•: ./deploy_start.sh
# =================================================================================

echo "========================================================"
echo "ğŸ”„ [Deploy Start] ë°°í¬ ì¤€ë¹„ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
echo "========================================================"

# 1. Git Stash (ë¡œì»¬ ë³€ê²½ ì‚¬í•­ ì„ì‹œ ì €ì¥)
echo "> ğŸ“¦ ë¡œì»¬ ë³€ê²½ ì‚¬í•­ì„ Stashì— ì €ì¥í•©ë‹ˆë‹¤..."
git stash
if [ $? -eq 0 ]; then
    echo "   âœ… Stash ì €ì¥ ì™„ë£Œ (ë˜ëŠ” ë³€ê²½ ì‚¬í•­ ì—†ìŒ)"
else
    echo "   âš ï¸ Stash ì €ì¥ ì¤‘ ê²½ê³  ë°œìƒ (ê³„ì† ì§„í–‰)"
fi

# 2. Git Pull (ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°)
echo "> ğŸ™ ì›ê²© ì €ì¥ì†Œì—ì„œ ìµœì‹  ì½”ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤ (git pull)..."
git pull
if [ $? -ne 0 ]; then
    echo "âŒ [ERROR] git pull ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë‚˜ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”."
    exit 1
fi
echo "   âœ… ìµœì‹  ì½”ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ"

# 3. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
echo "> ğŸ”‘ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ì— ì‹¤í–‰ ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤..."
# í”„ë¡œì íŠ¸ ë£¨íŠ¸ì˜ scripts í´ë” ë‚´ ëª¨ë“  .sh íŒŒì¼ì— ê¶Œí•œ ë¶€ì—¬
if [ -d "./scripts" ]; then
    chmod +x scripts/*.sh
    echo "   âœ… ./scripts/*.sh ê¶Œí•œ ë¶€ì—¬ ì™„ë£Œ"
else
    echo "   âš ï¸ ./scripts ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. í˜„ì¬ ìœ„ì¹˜($(pwd))ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
fi

# ë£¨íŠ¸ì— ìˆëŠ” ìŠ¤í¬ë¦½íŠ¸ë„ ê¶Œí•œ ë¶€ì—¬ (í˜¹ì‹œ ëª°ë¼ì„œ)
chmod +x *.sh 2>/dev/null

# 4. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
echo "========================================================"
echo "ğŸš€ [Deploy Start] ë°°í¬ ìŠ¤í¬ë¦½íŠ¸(deploy.sh)ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
echo "========================================================"

# deploy.shê°€ scripts í´ë”ì— ìˆëŠ”ì§€, ë£¨íŠ¸ì— ìˆëŠ”ì§€ í™•ì¸ í›„ ì‹¤í–‰
if [ -f "./scripts/deploy.sh" ]; then
    ./scripts/deploy.sh
elif [ -f "./deploy.sh" ]; then
    ./deploy.sh
else
    echo "âŒ [ERROR] 'deploy.sh' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    exit 1
fi